{% extends 'base.html' %}
{% load static %}
{% load socialaccount %}

{% block content %}

{% with media_item as item %}
{% include 'parts/back_button_title.html' %}
{% endwith %}

<div class="content">
    <figure class="image">
        {% if media_item.image %}
        <img src="{{ media_item.image.url }}">
        {% else %}
        <img src="{% static 'core/images/no_photo.jpeg' %}">
        {% endif %}
    </figure>
</div>

<div class="block is-flex" style="justify-content: space-around; margin-bottom: 0px;">

    <div style="justify-content: center;">
        <figure class="image is-24x24">
            <img src="{% static 'core/images/eye-outline.svg' %}" alt="eye">
        </figure>
        <div class="has-text-centered">{{ media_item.views }}</div>
    </div>

    <div style="justify-content: center;">
        <div class="has-text-centered"> media_item.likes </div>

            <figure class="image is-24x24">
                <a @click="like({{ media_item.slug }})" id="likes_button">
                    <img src="{% static 'core/images/heart-outline.svg' %}" alt="heart">
                </a>
            </figure>

<!--        <form action=" url 'like_view' media_item.subcategory.category.slug media_item.subcategory.slug media_item.slug " method="POST">-->
<!--             csrf_token -->
<!--            <figure class="image is-24x24">-->
<!--                <button type="submit" name="media_slug" value=" media_item.slug ">-->
<!--                    <img src=" static 'core/images/heart-outline.svg' " alt="heart">-->
<!--                </button>-->
<!--            </figure>-->
<!--        </form>-->

    </div>

</div>

<div class="content media_item_bottom">

    <div class="content">{{ media_item.description }}</div>

    <h2 class="subtitle">Reviews</h2>
    <div class="reviews-wrapper">
        {% for review in media_item.reviews.all %}
        <div class="notification space-below">
            <p>
                <strong>User: </strong>{{ review.user }},
                <strong>Date: </strong>{{ review.date_added|date:"d.m.Y" }}
            </p>
            {{ review.content }}
        </div>
        {% empty %}
        <div class="notification space-below">
            No reviews yet.
        </div>
        {% endfor %}
    </div>

    <div class="notification space-below" style="margin-top: 20px">
        {% if request.user.is_authenticated %}

        <form method="post" action=".">
            {% csrf_token %}
            <div class="field">
                <label>Leave the comment:</label>
                <div class="control">
                    <textarea class="textarea" name="content"></textarea>
                </div>
            </div>
            <div class="field">
                <div class="control">
                    <button class="button is-success">Submit</button>
                </div>
            </div>
        </form>

        {% else %}
        <p>
            Please&nbsp;
            <a href="{% provider_login_url 'google' %}">
                <strong>log in with Google</strong>
            </a>
            &nbsp;to leave a comment
        </p>
        {% endif %}

    </div>
</div>

{% endblock content %}
{% block scripts %}

<script>
var likes = new Vue({
    el: '#likes_button',
    delimiters: ['[[', ']]'],
    data() {
        return {
            slug: '{{ media_item.slug }}'
        }
    },
    methods: {
        like() {
            var data =  {
                'like': true,
                'slug': this.slug
            };

            console.log(data);

            fetch('/api/like/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(data)
                })
                .then((response) => {
                    console.log('response:', response)
                })
                .catch(function (error) {
                    console.log('error:', error);
                })
            }
        }
    })

</script>

{% endblock scripts %}