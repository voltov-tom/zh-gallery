{% extends 'base.html' %}
{% load static %}
{% load socialaccount %}

{% block content %}

{% with media_item as item %}
{% include 'parts/back_button_title.html' %}
{% endwith %}

<div class="content">
    <figure class="image">
        {% if media_item.image %}
        <img src="{{ media_item.image.url }}">
        {% else %}
        <img src="{% static 'core/images/no_photo.jpeg' %}">
        {% endif %}
    </figure>
</div>

<div class="block is-flex" style="justify-content: space-around; margin-bottom: 0px;">

    <div style="justify-content: center;">
        <figure class="image is-24x24">
            <img src="{% static 'core/images/eye-outline.svg' %}" alt="eye">
        </figure>
        <div class="has-text-centered">{{ media_item.views }}</div>
    </div>

    <div style="justify-content: center;" id="likes_button">

            <figure class="image is-24x24">
                <a @click="like()">
                    <img :src='heart_img' alt="like" >
                </a>
            </figure>

        <div class="has-text-centered">[[ likes_count ]]</div>
    </div>

</div>

<div class="content media_item_bottom">

    <div class="content">{{ media_item.description }}</div>

    <h2 class="subtitle">Reviews</h2>
    <div class="reviews-wrapper">
        {% for review in media_item.reviews.all %}
        <div class="notification space-below">
            <p>
                <strong>User: </strong>{{ review.user }},
                <strong>Date: </strong>{{ review.date_added|date:"d.m.Y" }}
            </p>
            {{ review.content }}
        </div>
        {% empty %}
        <div class="notification space-below">
            No reviews yet.
        </div>
        {% endfor %}
    </div>

    <div class="notification space-below" style="margin-top: 20px">
        {% if request.user.is_authenticated %}

        <form method="post" action=".">
            {% csrf_token %}
            <div class="field">
                <label>Leave the comment:</label>
                <div class="control">
                    <textarea class="textarea" name="content"></textarea>
                </div>
            </div>
            <div class="field">
                <div class="control">
                    <button class="button is-success">Submit</button>
                </div>
            </div>
        </form>

        {% else %}
        <p>
            Please&nbsp;
            <a href="{% provider_login_url 'google' %}">
                <strong>log in with Google</strong>
            </a>
            &nbsp;to leave a comment
        </p>
        {% endif %}

    </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
var likes = new Vue({
    el: '#likes_button',
    delimiters: ['[[', ']]'],

    data() {
        return {
            likes_count: {{ likes_count }},
            already_liked: {{ already_liked }},
            heart_img: null,
            media_id: '{{ media_item.id }}',
            img_dislike : "{% static 'core/images/heart-dislike-outline.svg' %}",
            img_like : "{% static 'core/images/heart-outline.svg' %}"
        }
    },

    created: function() {
        if (this.already_liked == true) {
            this.heart_img = this.img_dislike;
        } else {
            this.heart_img = this.img_like;
        }
    },

    methods: {
        like() {
            var data =  {
                "media_id": this.media_id,
                "operation": 'like_submit'
            };

            fetch("{% url 'like_button' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(data)
                })

                .then(response => response.json())
                .then(data => {
                    if ((data.success == true)&(data.liked == true)) {
                        this.heart_img = this.img_dislike,
                        this.likes_count += 1;

                    } else if ((data.success == true)&(data.liked == false)) {
                        this.heart_img = this.img_like,
                        this.likes_count -= 1;

                    } else {
                        console.log(response.data)
                    }
                })

                .catch(function (error) {
                    console.log('error:', error);
                })
            }
        }
    })
</script>

{% endblock scripts %}